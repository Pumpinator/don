<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Inventario - Don Galleto')}"/>
<body class="bg-latte-light">
<header th:replace="~{fragments :: header('Inventario de Materia Prima')}"/>
<main class="container mx-auto p-4 py-8">
    <div class="bg-white shadow-md rounded-lg p-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-chocolate mb-4 md:mb-0">Inventario de Materia Prima</h2>
            <div class="w-full md:w-1/3">
                <input type="text" id="searchInput" placeholder="Buscar productos..."
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red focus:border-transparent"
                />
            </div>
        </div>

        <!-- Inventory Status Summary -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-terracotta/10 p-4 rounded-lg">
                <h3 class="text-terracotta font-semibold">Insumos Bajos en Stock</h3>
                <p class="text-2xl font-bold text-terracotta-dark" th:text="${lowStockCount ?: 0}">0</p>
            </div>
            <div class="bg-red/10 p-4 rounded-lg">
                <h3 class="text-red font-semibold">Artículos Próximos a Expirar</h3>
                <p class="text-2xl font-bold text-red-dark" th:text="${expiringCount ?: 0}">0</p>
            </div>
            <div class="bg-red/10 p-4 rounded-lg">
                <h3 class="text-red font-semibold">Artículos Expirados</h3>
                <p class="text-2xl font-bold text-red-dark" th:text="${expiredCount ?: 0}">0</p>
            </div>
            <div class="bg-wood/10 p-4 rounded-lg">
                <h3 class="text-wood font-semibold">Total de Artículos</h3>
                <p class="text-2xl font-bold text-wood-dark" th:text="${#lists.size(rawMaterialInventory)}">0</p>
            </div>
        </div>

        <div class="mt-8">
            <!-- Table view for larger screens -->
            <div class="hidden md:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-dirt/10">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Materia Prima</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Cantidad</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Unidad de Medida</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Proveedor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Fecha de Expiración</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Estado</th>
                    </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Table rows will be dynamically populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Card view for smaller screens -->
            <div id="inventoryCardContainer" class="md:hidden grid grid-cols-1 gap-4">
                <!-- Cards will be dynamically populated here -->
            </div>
        </div>

        <div class="flex justify-center items-center mt-8">
            <a href="/compras/comprar"
               class="bg-red hover:bg-red-dark text-white font-bold h-16 w-full rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                <span class="text-center text-xl">Comprar Insumos</span>
            </a>
        </div>
    </div>
</main>
<button th:replace="~{fragments :: volverArriba}"/>
<footer th:replace="~{fragments :: footer}"/>

<script th:inline="javascript">
    const inventoryData = /*[[${rawMaterialInventory}]]*/ [];

    function renderInventory(data) {
        const tableBody = document.getElementById('inventoryTableBody');
        const cardContainer = document.getElementById('inventoryCardContainer');

        // Clear existing content
        tableBody.innerHTML = '';
        cardContainer.innerHTML = '';

        data.forEach(item => {
            // Render table row
            const row = document.createElement('tr');
            row.className = `${item.quantity < 10 ? 'bg-red/5' : (item.daysUntilExpiration < 30 ? 'bg-terracotta/5' : '')}`;
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="text-sm font-medium text-chocolate">${item.rawMaterial.name}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.quantity}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.measure.symbol}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.supplier.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${new Date(item.expirationDate).toLocaleDateString()}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${getStatusBadge(item)}
                </td>
            `;
            tableBody.appendChild(row);

            // Render card
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow';
            card.innerHTML = `
                <h3 class="font-bold text-lg mb-2">${item.rawMaterial.name}</h3>
                <p><span class="font-semibold">Cantidad:</span> ${item.quantity} ${item.measure.symbol}</p>
                <p><span class="font-semibold">Proveedor:</span> ${item.supplier.name}</p>
                <p><span class="font-semibold">Fecha de Expiración:</span> ${new Date(item.expirationDate).toLocaleDateString()}</p>
                <div class="mt-2">${getStatusBadge(item)}</div>
            `;
            cardContainer.appendChild(card);
        });
    }

    function getStatusBadge(item) {
        if (item.quantity < 10) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red/10 text-red">Bajo Stock</span>';
        } else if (item.expired) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-terracotta/10 text-terracotta">Expirado</span>';
        } else if (item.expiring && item.daysUntilExpiration < 7 && item.daysUntilExpiration >= 0) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-terracotta/10 text-terracotta">Próximo a Expirar</span>';
        } else {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-wood/10 text-wood">En Stock</span>';
        }
    }

    // Initial render
    renderInventory(inventoryData);

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(function(e) {
        const searchTerm = e.target.value.trim();
        if (searchTerm.length > 0) {
            fetch(`/materiaprima/${searchTerm}/inventario`)
                .then(response => response.json())
                .then(data => renderInventory(data))
                .catch(error => console.error('Error:', error));
        } else {
            renderInventory(inventoryData);
        }
    }, 300));

    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Highlight rows on hover (for larger screens)
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseenter', () => {
            row.classList.add('bg-latte/5');
        });
        row.addEventListener('mouseleave', () => {
            row.classList.remove('bg-latte/5');
        });
    });
</script>

</body>
</html>