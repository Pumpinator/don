<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Inventario - Don Galleto')}"/>
<body class="bg-latte-light">
<header th:replace="~{fragments/header :: header('Inventario de Materia Prima')}"/>
<main class="container mx-auto p-4 py-8">
    <div class="bg-white shadow-md rounded-lg p-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-terracotta/10 p-4 rounded-lg">
                <h3 class="text-terracotta font-semibold">Insumos Bajos en Stock</h3>
                <p class="text-2xl font-bold text-terracotta-dark" th:text="${lowStockCount ?: 0}">0</p>
            </div>
            <div class="bg-red/10 p-4 rounded-lg">
                <h3 class="text-red font-semibold">Artículos Próximos a Expirar</h3>
                <p class="text-2xl font-bold text-red-dark" th:text="${expiringCount ?: 0}">0</p>
            </div>
            <div class="bg-red/10 p-4 rounded-lg">
                <h3 class="text-red font-semibold">Artículos Expirados</h3>
                <p class="text-2xl font-bold text-red-dark" th:text="${expiredCount ?: 0}">0</p>
            </div>
            <div class="bg-wood/10 p-4 rounded-lg">
                <h3 class="text-wood font-semibold">Total de Artículos</h3>
                <p class="text-2xl font-bold text-wood-dark" th:text="${#lists.size(rawMaterialInventory)}">0</p>
            </div>
        </div>

        <div class="grid grid-cols-3">
            <div class="" th:each="rm : ${rawMaterial}">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-2" th:text="${rm.name}">Nombre del Insumo</h3>
                    <p th:text="${#lists.size(rawMaterialInventory.?[rawMaterial.name == ${rm.name}])}"></p>
                    <div class="mt-2">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-wood/10 text-wood">En Stock</span>
                    </div>
                    <button class="rounded-full bg-terracotta px-4 py-2 text-white font-bold">Acción</button>
                </div>
            </div>
        </div>


        <div class="mt-8 grid grid-cols-1 gap-8">
            <div class="w-full">
                <input type="text" id="searchInput" placeholder="Buscar productos en el inventario..."
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red focus:border-transparent"
                />
            </div>
            <div class="hidden md:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-dirt/10">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Materia
                            Prima
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">
                            Cantidad
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Unidad de
                            Medida
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">
                            Proveedor
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Fecha de
                            Expiración
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Estado
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-dirt uppercase tracking-wider">Acciones
                        </th>
                    </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div id="inventoryCardContainer" class="md:hidden grid grid-cols-1 gap-4">
            </div>
        </div>


        <div class="flex justify-center items-center mt-8">
            <button onclick="openModal()"
                    class="bg-red hover:bg-red-dark text-white font-bold h-16 w-full rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                <span class="text-center text-xl">Agregar Insumos</span>
            </button>
        </div>
    </div>
</main>
<div th:replace="fragments/modal :: modal">
    <h3 class="text-2xl font-bold text-chocolate" th:fragment="modalTitle">Agregar Insumo</h3>
    <div class="m-8" th:fragment="modalContent">
        <form id="purchaseForm" th:action="@{/inventario/materiaprima}" th:object="${inventoryItem}"
              method="POST" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="supplier" class="block text-md font-medium text-chocolate">Proveedor</label>
                    <select id="supplier" name="supplier" th:field="*{supplierId}"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50">
                        <option value="">Seleccione un proveedor</option>
                        <option th:each="supplier : ${suppliers}" th:value="${supplier.id}"
                                th:text="${supplier.name}"></option>
                    </select>
                </div>
                <div>
                    <label for="rawMaterial" class="block text-md font-medium text-chocolate">Materia Prima
                        <span>*</span></label>
                    <select id="rawMaterial" name="rawMaterial" th:field="*{rawMaterialId}"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                            required>
                        <option value="">Seleccione una materia prima</option>
                        <option th:each="rawMaterial : ${rawMaterial}" th:value="${rawMaterial.id}"
                                th:text="${rawMaterial.name}"></option>
                    </select>
                </div>
                <div>
                    <label for="measure" class="block text-md font-medium text-chocolate">Unidad de Medida
                        <span>*</span></label>
                    <select id="measure" name="measure" th:field="*{measureName}"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                            required>
                        <option value="">Seleccione una unidad de medida</option>
                        <option th:each="measure : ${measures}" th:value="${measure.name}"
                                th:text="${measure.name}"></option>
                    </select>
                </div>
                <div>
                    <label for="quantity" class="block text-md font-medium text-chocolate">Cantidad
                        <span>*</span></label>
                    <input type="number" id="quantity" name="quantity" step="0.01" min="1" th:field="*{quantity}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                           required>
                </div>
                <div>
                    <label for="unitPrice" class="block text-md font-medium text-chocolate">Precio Unitario</label>
                    <input type="number" id="unitPrice" name="unitPrice" step="0.01" th:field="*{unitPrice}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                    >
                </div>
                <div>
                    <label for="unitPrice" class="block text-md font-medium text-chocolate">Precio Total</label>
                    <input type="number" id="totalPrice" name="totalPrice" step="0.01" th:field="*{totalPrice}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                    >
                </div>
                <div>
                    <label for="expirationDate" class="block text-md font-medium text-chocolate">Fecha de Expiración
                        <span>*</span></label>
                    <input type="date" id="expirationDate" name="expirationDate" th:field="*{expirationDate}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-terracotta focus:ring focus:ring-terracotta focus:ring-opacity-50"
                           required>
                </div>
            </div>
            <div class="flex justify-center p-4 border-t">
                <a onclick="closeModal()"
                   class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 hover:cursor-pointer rounded mr-2">
                    Cancelar
                </a>
                <button type="submit" class="bg-red hover:bg-red-dark text-white font-bold py-2 px-4 rounded">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>
<button th:replace="~{fragments/goTop :: goTop}"/>
<footer th:replace="~{fragments/footer :: footer}"/>

<script th:inline="javascript">
    const inventoryData = /*[[${rawMaterialInventory}]]*/ [];

    document.addEventListener('DOMContentLoaded', () => {
        const unitPrice = document.getElementById('unitPrice');
        const quantity = document.getElementById('quantity');
        const totalPrice = document.getElementById('totalPrice');

        if (quantity) {
            unitPrice.addEventListener('input', () => {
                totalPrice.value = (unitPrice.value * quantity.value).toFixed(2);
            });

            totalPrice.addEventListener('input', () => {
                unitPrice.value = (totalPrice.value / quantity.value).toFixed(2);
            });
        }

        if (unitPrice) {
            quantity.addEventListener('input', () => {
                totalPrice.value = (unitPrice.value * quantity.value).toFixed(2);
            });
        } else if (totalPrice) {
            quantity.addEventListener('input', () => {
                unitPrice.value = (totalPrice.value / quantity.value).toFixed(2);
            });
        }

    });

    function renderInventory(data) {
        const tableBody = document.getElementById('inventoryTableBody');
        const cardContainer = document.getElementById('inventoryCardContainer');

        tableBody.innerHTML = '';
        cardContainer.innerHTML = '';

        data.forEach(item => {
            const row = document.createElement('tr');
            row.className = `${item.quantity < 10 ? 'bg-red/5' : (item.daysUntilExpiration < 30 ? 'bg-terracotta/5' : '')}`;
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="text-sm font-medium text-chocolate">${item.rawMaterial.name}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.quantity}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.measure.symbol}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${item.supplier ? item.supplier.name : 'Sin proveedor'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-dirt">${new Date(item.expirationDate).toLocaleDateString()}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${getStatusBadge(item)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="rounded-full bg-terracotta px-4 py-2 text-white font-bold hover:bg-terracotta-dark">Acción</button>
                </td>
            `;
            tableBody.appendChild(row);

            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow';
            card.innerHTML = `
                <h3 class="font-bold text-lg mb-2">${item.rawMaterial.name}</h3>
                <p><span class="font-semibold">Cantidad:</span> ${item.quantity} ${item.measure.symbol}</p>
                <p><span class="font-semibold">Proveedor:</span> ${item.supplier ? item.supplier.name : 'Sin proveedor'}</p>
                <p><span class="font-semibold">Fecha de Expiración:</span> ${new Date(item.expirationDate).toLocaleDateString()}</p>
                <div class="mt-2">${getStatusBadge(item)}</div>
                <button class="rounded-full bg-terracotta mx-4 my-2 text-white font-bold">Acción</button>
            `;
            cardContainer.appendChild(card);
        });
    }

    function getStatusBadge(item) {
        if (item.quantity < 10) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red/10 text-red">Bajo Stock</span>';
        } else if (item.expired) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-terracotta/10 text-terracotta">Expirado</span>';
        } else if (item.expiring && item.daysUntilExpiration < 7 && item.daysUntilExpiration >= 0) {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-terracotta/10 text-terracotta">Próximo a Expirar</span>';
        } else {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-wood/10 text-wood">En Stock</span>';
        }
    }

    renderInventory(inventoryData);

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(function (e) {
        const searchParam = e.target.value.trim();
        if (searchParam.length > 0) {
            fetch(`/api/inventario/materiaprima/${searchParam}`)
                .then(response => response.json())
                .then(data => renderInventory(data))
                .catch(error => console.error('Error:', error));
        } else {
            renderInventory(inventoryData);
        }
    }, 300));

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseenter', () => {
            row.classList.add('bg-latte/5');
        });
        row.addEventListener('mouseleave', () => {
            row.classList.remove('bg-latte/5');
        });
    });

</script>
</body>
</html>